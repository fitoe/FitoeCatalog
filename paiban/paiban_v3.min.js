function Saver(){Saved||(savepic(),Saved=!0,$("#SaveBtn").attr("title","已保存"),$("#SaveBtn").html("<i class='fa fa-check'> 就绪</i>"))}function savepic(){var b,c,d,a=[];$("#foldersbox li").each(function(){var d={};d.name=$(this).find(".text").text(),a.push(d)}),b=[],$("#picbox li:not('.ui-state-highlight')").each(function(a,c){var d,e;return"undefined"==typeof $(c).find("img").attr("bigsrc")?!0:(d={},d.url=$(c).find("img").attr("bigsrc"),e=new RegExp(loc,"g"),d.url=d.url.replace(e,""),console.info("信息："+d.url),d.alt=$(c).find("img").attr("alt"),$(c).find(".text").text()!==$(c).find("img").attr("alt")&&(d.name=$(c).find(".text").text()),$(c).attr("fenlei")&&"未分类"!==$(c).attr("fenlei")&&(d.fenlei=$(c).attr("fenlei")),"undefined"!=typeof $(c).attr("ext")&&(d.ext=$.trim($(c).attr("ext"))),"undefined"!=typeof $(c).attr("title")&&(d.title=$.trim($(c).attr("title"))),b.push(d),void 0)}),c=[],d={},d.folder=a,d.pics=b,c={folder:a,pics:b},$.ajax({url:"/paiban_v3.php",type:"POST",cache:!1,data:{action:"savepic",catid:thecatid,id:theid,json:$.toJSON(c)},dataType:"json",error:function(a,b){$("#debug").html(b)},success:function(){}})}function getpic(){$.ajax({url:"/paiban_v3.php",type:"POST",cache:!1,data:{action:"getpic",catid:thecatid,id:theid},dataType:"json",error:function(){},success:function(a){var c,d;"undefined"!=typeof a.folder&&($.each(a.folder,function(a,b){addfolder(b.name,!1)}),$("#addfolder").before(newFolder),newFolder=""),c=[$.each(a.pics,function(a,b){addpic(b.url,b.name,b.alt,b.fenlei,b.title,b.ext)}),$("#picbox").append(newLI),newLI=""],d=function(){$(document).dequeue("at3")},$(document).queue("at3",c),d()}})}function GetFields(){for(ary=thefields.split(","),brr="",console.log(ary.length),i=0;i<ary.length;i++)bry=ary[i].split("|"),$("#fieldname").after("<div class='form-group'><label for='dia_"+bry[1]+"' class='col-sm-3 control-label'>"+bry[0]+":</label><div class='col-sm-9'><input type='text' class='form-control' id='"+"dia_"+bry[1]+"' ></div></div>")}function addpic(a,b,c,d,e,f){var h,i,j,k,l,m,n,g="<li class='ui-corner-all' ";g+="undefined"==typeof d?" fenlei='未分类'":" fenlei='"+d+"'","undefined"!=typeof e&&""!==$.trim(e)&&(g+=" title='"+e+"'",h="<li rel="+a+">"+e+"</li>"),"undefined"!=typeof f&&""!==$.trim(f)&&(g+=" ext='"+f+"'"),g+="><div class='photo'>",i=a.replace(/[^\/]*[\/]+/g,""),i=a.replace(i,"thumb_160_140_"+i),j=new RegExp(loc,"g"),i=i.replace(j,""),k="<img src='"+loc+i+"' bigsrc='"+loc+a+"' alt='"+c+"' />",l="<div class='text'>",l+=b?b:c,l+="</div>",m="</div></li>",n=g+k+l+m,newLI+=n,"undefined"!=typeof h&&(newMemo+=h)}function BuildMemoList(){var b,a=$("#picbox li[title]:not([title=''])");$("#memos").html(""),b="",$(a).each(function(){b+="<li rel="+$(this).find("img").attr("bigsrc")+">"+$(this).attr("title")+"</li>"}),$("#memos").append(b),$("#allnotes .bubble").text($("#memos li").size())}function inArray(a,b,c){var d,e;if("string"==typeof a||"number"==typeof a){for(d=b.length,e=0;d>e;e++)if(a===b[e])return c?e:!0;return!1}}function RecycleDroptable(){$("#recycle").droppable({tolerance:"touch",hoverClass:"recycledropclass",drop:function(a,b){"picbox"==b.draggable.closest("div").attr("id")?b.draggable.hasClass("active")?delpic($("#picbox .active")):delpic(b.draggable):delfolder(b.draggable)}})}function FolderDroptable(){$("#foldersbox li").droppable({accept:"#picbox li",hoverClass:"folderdrop",tolerance:"pointer",drop:function(a,b){b.draggable.attr("fenlei",$(this).find(".text").text()),$("#picbox .active").attr("fenlei",$(this).find(".text").text()),b.draggable.hide(),$("#picbox .active").hide(),refreshbubble(),RefreshFenleiProgress(),RefreshRenameProgress(),NotSave()}})}function NotSave(){Saved=!1,$("#SaveBtn").attr("title","立即保存"),$("#SaveBtn").html("<i class='fa fa-floppy-o'> 保存</i>")}function MakeFolderEditable(a){$(a).editable({editby:"click",type:"text",submitBy:"blur",onSubmit:function(){var a=$(this).closest("li").find(".text").text(),b=$(this).text();return""==$(this).text()?($(this).closest(".text").text(a),!1):(CheckFolderName()?($("#picbox li[fenlei='"+a+"']").attr("fenlei",b),$("#foldersbox .active").attr("name",b),NotSave()):($(this).closest(".text").text(a),alert("重名文件夹")),void 0)}})}function MakePicEditable(a){$(a).editable({editby:"click",type:"text",submitBy:"blur",onSubmit:function(){return""==$(this).text()?($(this).closest(".text").text("未命名"),!1):(NotSave(),RefreshRenameProgress(),void 0)}})}function MakeMemolistClickable(){$("body").on("click","#memos li",function(){var a=GetObjFromSrc($(this).attr("rel"));Dialoger($(a))})}function RestoreHistory(a){$.ajax({url:"/paiban_v3.php",type:"POST",cache:!1,data:{action:"RestoreHistory",id:a},dataType:"json",error:function(a,b){alert("载入历史记录时出错："+b)},success:function(a){var c,d;$("#foldersbox li").remove(),$("#picbox").empty(),c=[$.each(a.folder,function(a,b){addfolder(b.name,!1)}),$("#addfolder").before(newFolder),newFolder="",$.each(a.pics,function(a,b){addpic(b.url,b.name,b.alt,b.fenlei,b.title,b.ext)}),$("#picbox").append(newLI),newLI="",after(),NotSave(),$("#historyhelpBlock").text("历史记录恢复成功")],d=function(){$(document).dequeue("at")},$(document).queue("at",c),d()}})}function gethistory(a){$.ajax({url:"/paiban_v3.php",type:"POST",cache:!1,data:{action:"gethistory",id:theid,thepage:a},dataType:"json",error:function(){},success:function(a){$("#historylist tbody tr").not("tr:first").empty(),$.each(a,function(a,b){addhistory(b)})}})}function delpic(a){return"回收站"==$(a).attr("fenlei")?!1:($(a).attr("fenlei","回收站"),$(a).hide(),refreshbubble(),RefreshFenleiProgress(),RefreshRenameProgress(),NotSave(),void 0)}function delfolder(a){$("#picbox li[fenlei='"+$(a).find(".text").text()+"']").attr("fenlei","回收站"),$(a).remove(),$("#picbox li").hide(),ResizeFoldersbox(),refreshbubble(),NotSave()}function addfolder(a,b){var c,d,f;return"回收站"==a?!1:"未命名"==a?!1:"未分类"==a?!1:(d="<li class='ui-corner-all'><div class=text>",f="</div><div class='bubble'>0</div></li>",b?(c=d+a+f,$("#addfolder").before(c)):(c=d+a+f,newFolder+=c),void 0)}function addhistory(a){$("#historylist").append("<tr><td>自动保存</td><td>"+a.time+"</td><td><button type='button' role='"+a.id+"' class='RestoreBtn btn btn-default btn-xs'><i class='fa fa-reply'></i> 恢复</button></td></tr>")}function Checkname(){var a=!0;return $("#picbox li").not(".active").each(function(){{$(this).find(".text").text(),$("#picbox .active").find(".text").text()}}),a}function CheckFolderName(){var a=!0;return $("#foldersbox li").each(function(){return $(this).find(".text").text()==$("#NewFolderName").val()?(a=!1,!1):void 0}),a}function Dialoger(a){MakeNextShow(a);var b=new GetSlide(a);$("#SlideTitle").text(b.title)}function MakeNextShow(a){var c,d,e,f,g,b=new GetSlide(a);$("#dia_img").attr("src",b.src),pimsize(b.img,$("#dia_img").css("max-width"),$("#dia_img").css("max-height")),c=new Image,c.src=b.bigsrc,c.onload=function(){$("#dia_img").attr("src",b.bigsrc)},d=$("#picbox li:visible"),$(d).size()<2&&(d=$("#picbox li")),e=$("#dia_img").attr("src"),f=e.indexOf("thumb_160_140_")>0?d.has("img[src='"+e+"']"):d.has("img[bigsrc='"+e+"']"),$("#dia_title").val(b.title),$("#note").val($(a).attr("title")),$("#dia_ext").val($(a).attr("ext")),$("#dia_ul").html(""),$("#dia_ul").append("<li><a href='#'><span>未分类</span></a></li>"),$("#dia_ul li:last").text()==$(a).attr("fenlei")&&$("#dia_ul li:last").addClass("checked"),$("#foldersbox .text").each(function(){$("#dia_ul").append("<li><a href='#'><span>"+$(this).text()+"</span></a></li>"),$("#dia_ul li:last").text()==$(a).attr("fenlei")&&$("#dia_ul li:last").addClass("checked")}),g=new Image,g.src=$(b.next()).find("img").attr("bigsrc")}function GetSlide(a){var b,e,f;this.me=a,this.title=$(a).find(".text").text(),this.src=$(a).find("img").attr("src"),this.fenlei=$(a).attr("fenlei"),this.img=$(a).find("img"),this.memo=$(a).attr("title"),this.ext=$(a).attr("ext"),this.bigsrc=$(a).find("img").attr("bigsrc"),this.count=$("#picbox li:visible").size(),this.reget=function(){f=$("#dia_img").attr("src"),e=$("#picbox li:visible"),b=f.indexOf("thumb_160_140_")>0?$(e).has("img[src='"+f+"']"):$(e).has("img[bigsrc='"+f+"']")},this.obj=function(){return this.reget(),$(b)},this.pre=function(){this.reget();var a;return a=$(e).index($(b))-1<0?$(e).eq($(e).size()-1):$(e).eq($(e).index($(b))-1)},this.next=function(){return this.reget(),$(e).index($(b))+1>=$(e).size()?$($(e).eq(0)):$(e).eq($(e).index($(b))+1)}}function pimsize(a,b,c){var e,f,g,d=new RegExp("px","g");b=b.replace(d,""),c=c.replace(d,""),console.log(b),console.log(c),e=$(a).width(),f=$(a).height(),e>=f&&(g=e/b,f/=g,e=b),f>e&&(g=f/c,e/=g,f=c),0!==e&&$("#dia_img").attr("width",e),0!==f&&$("#dia_img").attr("height",f)}function PreloadImg(a){var b=new Image;b.src=a}function RefreshRenameProgress(){var c,a=0,b=$("#picbox li").size()-$("#picbox li[fenlei='回收站']").size();$("#picbox li").each(function(){var d=$(this).find("img").attr("alt"),e=$(this).find(".text").text();d!==e&&"回收站"!==$(this).attr("fenlei")&&a++}),c=Math.floor(100*a/b),$("#norename .bubble").text(b-a),$("#myStat").empty(),100==c?$("#prg_name").text("完成"):$("#prg_name").text(c+"%"),$("#prg_name").css("width",c+"%")}function RefreshFenleiProgress(){var a=0,b=$("#picbox li").size(),c=$("#picbox li[fenlei!='未分类']").size();a=Math.floor(100*c/b),100==a?$("#prg_item").text("完成"):$("#prg_item").text(a+"%"),$("#prg_item").css("width",a+"%")}function RefreshGuigeProgress(){var a=0,b=$("#picbox li").size()-$("#picbox li[fenlei='回收站']").size(),c=$("#picbox li:not([ext][ext!=''])").size()-$("#picbox li[fenlei='回收站']").size();a=100*(b-c)/b,a=Math.floor(a),100==a?$("#prg_guige").text("完成"):$("#prg_guige").text(a+"%"),$("#prg_guige").css("width",a+"%")}function ItemActive(a){$("#picbox li.active").removeClass("active"),$("#foldersbox .active").removeClass("active"),$("#filter .active").removeClass("active"),$("#recycle").removeClass("active"),$(a).addClass("active")}function selfolder(a){ItemActive(a)}function selpic(a){var d,b=$("#picbox li:visible").index(a),c=$("#picbox li:visible").index($("#picbox .active"));if(key.ctrl&&!key.isPressed("a"))$(a).toggleClass("active");else if(key.shift)if(b>c)for(d=c+1;b>=d;d++)$("#picbox li:visible").eq(d).addClass("active");else for(d=b;c+1>d;d++)$("#picbox li:visible").eq(d).addClass("active");else $("#picbox li").removeClass("active"),$(a).addClass("active")}function refreshbubble(){$("#foldersbox li").each(function(){$(this).find(".bubble").text($("#picbox li[fenlei='"+$(this).find(".text").text()+"']").size())}),$("#allfolder .bubble").text($("#picbox li:not('.ui-state-highlight')").size()-$("#picbox li[fenlei='回收站']").size()),$("#nofenlei .bubble").text($("#picbox li[fenlei='未分类']").size()),$("#recycle .bubble").text($("#picbox li[fenlei='回收站']").size()),"0"!==$("#recycle .bubble").text()?$("#recycle").css("background-image","url(/statics/images/paiban/recycled.png)"):$("#recycle").css("background-image","url(/statics/images/paiban/recycle.png)")}function RefreshMemoBuble(){$("#allnotes .bubble").text($("#memos li").size())}function GetObjFromSrc(a){var b=$("#picbox .photo img[bigsrc='"+a+"']").parentsUntil("li").parent();return $(b)}function ResizeFoldersbox(){var a=114*($("#foldersbox li").size()+2)-40;$("#foldersbox").width(a),$("#foldermain").mCustomScrollbar({axis:"x",theme:"minimal-dark",mouseWheel:{preventDefault:!0},scrollAmount:1,advanced:{autoExpandHorizontalScroll:!0,updateOnBrowserResize:!0,updateOnContentResize:!0,autoExpandHorizontalScroll:!0},scrollInertia:0,autoExpandScrollbar:!0}),$("#foldermain").mCustomScrollbar("update")}function SlideDel(){var a=GetObjFromSrc($("#dia_img").attr("src")),b=new GetSlide(a);return 0==b.count-1?($("#dialog").modal("hide"),!1):(SlideNext(),delpic(b.pre()),void 0)}function SlideNext(){return ifwheel?!1:($("#dia_title,#dia_ext,#note").blur(),$("#SlideNext").trigger("click"),ifwheel=!0,setTimeout("ifwheel=false;",800),void 0)}function SlidePrev(){return ifwheel?!1:($("#dia_title,#dia_ext,#note").blur(),$("#SlidePrev").trigger("click"),ifwheel=!0,setTimeout("ifwheel=false;",500),void 0)}function getFileName(a){var b=/[^\/]*[\/]+/g;return a=a.replace(b,"")}function MakeBookSortable(){$("#desk").sortable({connectWith:"#desk",items:"li:visible",placeholder:"ui-state-highlight ui-corner-all",cursor:"move",revert:200,tolerance:"pointer",opacity:.5,sort:function(){},activate:function(){},over:function(){},update:function(){RefillPage(3,4)}})}function startIntro(){var a=introJs();a.setOptions({steps:[{element:"#toolbar",intro:"上面这排按钮可以看哪些没完成",position:"bottom"},{element:"#addfolder",intro:"新建一个分类",position:"right"},{element:"#foldersbox li",intro:"把图片拖放到文件夹可以分类",position:"right"},{intro:"前后拖动图片可以排序，双击看大图"},{element:"#progress",intro:"这里可以看到进度，点击可以看到没完成的",position:"left"},{element:"#guide",intro:"点这里再看一遍，或者完成",position:"left"}],nextLabel:"下一步 →",prevLabel:"← 上一步",skipLabel:"退出",doneLabel:"完成",exitOnEsc:!0,exitOnOverlayClick:!0,showStepNumbers:!1,keyboardNavigation:!0,showButtons:!0,bullets:!1,showProgress:!1,scrollToElement:!0,overlayOpacity:.8,disableInteraction:!1}),a.start()}function MakePicsSortable(){$("#picbox").sortable({connectWith:"#picbox",items:">li:visible",placeholder:"ui-state-highlight ui-corner-all",cursor:"move",revert:100,tolerance:"pointer",opacity:.5,distance:30,activate:function(){},sort:function(){},update:function(){NotSave()}})}function contactmenu(){var a={};a["new"]={icon:"fa-folder-o",text:"新建文件夹",click:function(){$("#addfolder").trigger("click")}},a["rename"]={icon:"fa-pencil-square-o",text:"重命名",click:function(a){selfolder(a),$("#ModalCreatFolder").modal("show")}},a["del"]={icon:"fa-times",text:"删除",click:function(a){delfolder(a)}},$("#foldersbox li").contextMenu(a),a={},a["new"]={icon:"fa-folder-o",text:"新建文件夹",click:function(){$("#addfolder").trigger("click")}},$("#foldersbox").contextMenu(a)}function Init(){$("#nofenlei").trigger("click"),loadimage(),Saved=!0,$("#Search").val(""),thetimer=self.setInterval("Saver()",3e4)}function loadimage(){PreloadImg("/statics/images/paiban/folder.png"),PreloadImg("/statics/images/paiban/folder-sel.png"),PreloadImg("/statics/images/paiban/folder-hover.png"),PreloadImg("/statics/images/paiban/recycled.png"),PreloadImg("/statics/images/paiban/recycled-hover.png")}function after(){var a=[Init(),$("#nofenlei").trigger("click"),contactmenu(),MakePicsSortable(),RecycleDroptable(),checkmissed(),ShowPanels(),Loaded=!0],b=function(){$(document).dequeue("at2")};$(document).queue("at2",a),b()}function fadeshow(a){$(a).fadeIn(del)}function ShowPanels(){speed=300,$("#navbar").fadeIn(speed,function(){$("#foldersbox").fadeIn(speed,function(){$("#filter").fadeIn(speed,function(){refreshbubble(),$("#prg_item_div").fadeIn(speed,function(){$("#prg_name_div").fadeIn(speed,function(){RefreshFenleiProgress(),$("#prg_guige_div").fadeIn(speed,function(){RefreshRenameProgress(),$("#recycle").fadeIn(speed,function(){RefreshGuigeProgress(),$("#exbtn").fadeIn(speed,function(){$("#picbox").fadeIn(speed,function(){})})})})})})})})})}function checkmissed(){var b,c,a=0;$("#foldersbox li").each(function(){a+=$("#picbox li[fenlei='"+$(this).find(".text").text()+"']").size()}),a+=$("#picbox li[fenlei='回收站']").size(),a!==$("#picbox li").size()&&(b=[],$("#foldersbox li").each(function(){b.push($(this).find(".text").text())}),c=$("#picbox li"),$(b).each(function(){c=$(c).not($("#picbox li[fenlei='"+this+"']"))}),c=$(c).not($("#picbox li[fenlei='回收站']")),$(c).each(function(){var d=$(this).attr("fenlei");inArray(d,b,!1)||(addfolder(d,!0),b.push(d))})),ResizeFoldersbox(),FolderDroptable()}function RefillPage(a,b){$("#desk .page").each(function(){var e=a*b,f=$(this).find(">li").not(".ui-state-highlight").size();f>e?$(this).find(">li:gt("+(e-1)+")").prependTo($(this).next(".page")):e>f&&$(this).next(".page").find(">li:lt("+(e-f)+")").appendTo($(this))})}function ifSlideShown(){return"block"==$("#dialog").css("display")?!0:!1}function Fillpics(a,b){var c,d,e;for($("#picbox li").show(),c=$("#picbox li").size(),d=Math.ceil(c/(a*b)),e=a*b,CreatPage(d),i=0;d>=i;i++)for(a=0;e>a;a++)$("#picbox li:eq(0)").appendTo("#desk .page:eq("+i+")");$("#desk li").show(),MakeBookSortable()}function CreatBook(){var c,d,e,a=$(window).height();$(window).width(),c=.85*a,d=2*.7*c,console.info("deskW："+d+"deskH"+c),$("body").append("<div id='desk'></div>"),$("#desk").height(c),$("#desk").width(d),e=dialog({id:"deskshow",title:"效果预览",width:d+20,height:c+20,padding:0,quickClose:!1,content:$("#desk"),button:[{value:"上一页",callback:function(){return!1},autofocus:!0},{value:"下一页",callback:function(){return!1},autofocus:!0}]}),e.reset(),e.showModal(),Fillpics(3,4)}function CreatPage(a){var b=$("#desk").height(),c=$("#desk").width()/2.02;for(console.info("信息："+$("#desk").html()),x=1;a>=x;x++)0==x%2?$("#desk").append("<div class='page right'></div>"):$("#desk").append("<div class='page left'></div>");$("#desk .page").height(b),$("#desk .page").width(c)}Pace.on("done",function(){after()}),newFolder="",newLI="",newMemo="",loc="http://"+window.location.host+"/uploadfile/",Saved=!0,ifwheel=!1,Loaded=!1,$(document).ready(function(){$("#foldersbox").sortable({cursor:"move",opacity:.5,distance:40,revert:100,zIndex:999,cancel:"#addfolder",cursor:"move",update:function(){$("#addfolder").index()<$("#foldersbox li").size(),NotSave()}}),$("#foldersbox").on("click","li,input",function(a){var b,c;"<input>"!==$(a.target).html()?(selfolder(this),$("#picbox li").hide(),$("#picbox li").removeClass("active"),b=$(this).find(".text").text(),c=$("#picbox li[fenlei='"+b+"']"),c.show()):a.preventDefault()}),$("#foldersbox").on("keypress","input",function(){selfolder($(this).closest("li"))}),$("#picbox").on("click",">li",function(){selpic(this)}),$("#picbox").on("dblclick","li",function(){$("#dialog").modal("show"),Dialoger(this)}),$("#ModalHistory").on("show.bs.modal",function(){gethistory(1)}),$("body").on("keypress","#NewFolderName",function(a){13==a.which&&$("#folderok").trigger("click")}),$("body").on("keypress","input",function(a){13==a.which&&$("input").blur()}),$("body").on("change","#dia_title",function(){$("#picbox li .photo img[bigsrc='"+$("#dia_img").attr("src")+"']").next().text($(this).val()),$("#SlideTitle").text($(this).val()),NotSave(),RefreshRenameProgress()}),$("body").on("change","#dia_ext",function(){GetObjFromSrc($("#dia_img").attr("src")).attr("ext",$(this).val()),RefreshGuigeProgress(),NotSave()}),$("#prg_name_div").on("click",function(){$("#norename").trigger("click")}),$("#prg_item_div").on("click",function(){$("#nofenlei").trigger("click")}),$("#SaveBtn").on("click",function(){Saved||Saver()}),$("#prg_guige_div").on("click",function(){$("#foldersbox .active").removeClass("active"),$("#picbox li").hide(),$("#picbox li:not([ext][ext!=''])").show()}),$("body").on("click","#ModalHistory .RestoreBtn",function(){RestoreHistory($(this).attr("role"))}),$("body").on("mousewheel","#dialog",function(a,b){return ifwheel?!1:(b>0?SlidePrev():0>b&&SlideNext(),a.preventDefault(),ifwheel=!0,setTimeout("ifwheel=false;",1e3),void 0)}),$("body").on("keypress","#dialog",function(a){switch(a.keyCode){case 33:a.preventDefault(),SlidePrev();break;case 34:a.preventDefault(),SlideNext()}}),$("#SlideNext").on("click",function(){var a=GetObjFromSrc($("#dia_img").attr("src")),b=new GetSlide(a);return 0==b.count?($("#dialog").modal("hide"),!1):(MakeNextShow(b.next()),$("#SlideTitle").text($(b.obj()).find(".text").text()),void 0)}),$("#SlidePrev").on("click",function(){var a=GetObjFromSrc($("#dia_img").attr("src")),b=new GetSlide(a);return 0==b.count?($("#dialog").modal("hide"),!1):(MakeNextShow(b.pre()),$("#SlideTitle").text($(b.obj()).find(".text").text()),void 0)}),$("body").on("click","#dialog li",function(){var a,b;$("#dialog li").removeClass("checked"),$(this).addClass("checked"),a=GetObjFromSrc($("#dia_img").attr("src")),$(a).attr("fenlei",$(this).text()),NotSave(),refreshbubble(),b=$("#foldersbox .active").find(".text").text(),"undefined"==typeof b?"未分类"==$(a).attr("fenlei")?a.show():a.hide():$(a).attr("fenlei")==b?a.show():a.hide()}),$("body").on("keyup","#Search",function(){return""==$(this).val()?!1:(SearchTemp=$("#picbox li:visible"),$("#picbox li:visible").hide(),$("#picbox li:contains('"+$(this).val()+"')").show(),$("#picbox li[ext*='"+$(recycle).val()+"']").show(),$("#picbox li[title*='"+$(recycle).val()+"']").show(),void 0)}),$("body").on("change","#note",function(){var a=$("#picbox li .photo img[bigsrc='"+$("#dia_img").attr("src")+"']").parentsUntil("li").parent();$(a).attr("title",$(this).val()),BuildMemoList(),NotSave()}),$("body").on("click","#SlideDel",function(){SlideDel()}),$("#ModalCreatFolder").on("show.bs.modal",function(){$("#foldersbox .active").size()>0?($("#CreatModalLabel").text("重命名文件夹"),$("#CreatFolderLabel").text("新名称"),$("#NewFolderName").val($("#foldersbox .active").find(".text").text())):($("#CreatModalLabel").text("新建文件夹"),$("#CreatFolderLabel").text("文件夹名称"),$("#NewFolderName").val("")),$("#helpBlock").text("")}),$("#ModalCreatFolder").on("shown.bs.modal",function(){$("#NewFolderName").focus()}),$("body").on("click","#HistoryOk",function(){gethistory(1)}),$("body").on("click","#folderok",function(){var a,b;return""==$("#NewFolderName").val()?($("#ModalCreatFolder .modal-body .form-group").addClass("has-error"),$("#helpBlock").text("名称不能为空"),$("#NewFolderName").focus(),!1):CheckFolderName()?$("#foldersbox .active").size()>0?(a=$("#foldersbox .active").find(".text").text(),b=$("#NewFolderName").val(),$("#picbox li[fenlei='"+a+"']").attr("fenlei",b),$("#foldersbox .active").find(".text").text(b),NotSave(),$("#ModalCreatFolder").modal("hide"),!1):(addfolder($("#NewFolderName").val(),!0),ResizeFoldersbox(),$("#ModalCreatFolder .modal-body .form-group").removeClass("has-error"),$("#NewFolderName").val(""),$("#helpBlock").text(""),FolderDroptable(),contactmenu(),NotSave(),$("#ModalCreatFolder").modal("hide"),void 0):($("#ModalCreatFolder .modal-body .form-group").addClass("has-error"),$("#helpBlock").text("文件夹已存在"),$("#NewFolderName").focus(),!1)}),$("#addfolder").on("click",function(){$("#foldersbox .active").removeClass("active"),$("#ModalCreatFolder").modal("show")}),$("#recycle").on("click",function(){ItemActive(this),$("#picbox li").hide(),$("#picbox li[fenlei='回收站']").show()}),$("#allnotes").on("click",function(){var a=dialog({quickClose:!0,padding:0,content:$("#memoselect").html()});a.show(document.getElementById("allnotes"))}),$("#guide").on("click",function(){startIntro()}),$("#preview").on("click",function(){CreatBook()}),$("#nofenlei").on("click",function(){$("#foldersbox .active").removeClass("active"),$("#picbox li").hide(),$("#picbox li[fenlei='未分类']").show()}),$("#norename").on("click",function(){$("#picbox li").hide(),$("#picbox li").each(function(){var c=$(this).find("img").attr("alt"),d=$(this).find(".text").text();c==d&&"回收站"!==$(this).attr("fenlei")&&$(this).show()})}),$("#filter a").on("click",function(){ItemActive(this),$(this).blur()}),$("#allfolder").on("click",function(){$("#picbox li").hide(),$("#picbox li[fenlei!='回收站']").show()}),$("#nofenlei").droppable({accept:"#picbox li",tolerance:"pointer",drop:function(a,b){b.draggable.hasClass("active")?($("#picbox .active").attr("fenlei","未分类"),$("#picbox .active").hide()):(b.draggable.attr("fenlei","未分类"),b.draggable.hide()),NotSave(),refreshbubble(),RefreshFenleiProgress(),RefreshRenameProgress()}}),key("ctrl+a",function(a){a.preventDefault(),selpic($("#picbox li:visible"))}),key("ctrl+s",function(a){var b=navigator.userAgent;return b.indexOf("Firefox")>-1?!1:(a.preventDefault(),Saver(),void 0)}),key("del",function(){ifSlideShown()?SlideDel():$("#picbox .active").size()?delpic($("#picbox .active")):delfolder($("#foldersbox .active"))}),key("pagedown",function(){SlideNext()}),key("pageup",function(){SlidePrev()}),getpic()});